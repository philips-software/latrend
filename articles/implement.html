<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementing new methods • latrend</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Implementing new methods">
<meta property="og:description" content="latrend">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">latrend</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.4.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demo.html">Demonstration of latrend package</a>
    </li>
    <li>
      <a href="../articles/implement.html">Implementing new methods</a>
    </li>
    <li>
      <a href="../articles/simulation.html">Conducting a simulation study</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/philips-software/latrend/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Implementing new methods</h1>
                        <h4 data-toc-skip class="author">Niek Den
Teuling</h4>
            
            <h4 data-toc-skip class="date">2021-01-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/philips-software/latrend/blob/HEAD/vignettes/implement.Rmd" class="external-link"><code>vignettes/implement.Rmd</code></a></small>
      <div class="hidden name"><code>implement.Rmd</code></div>

    </div>

    
    
<p>In this vignette we demonstrate how to define new methods.</p>
<div class="section level2">
<h2 id="case-study-data">Case study data<a class="anchor" aria-label="anchor" href="#case-study-data"></a>
</h2>
<p>We will generate a dataset comprising two clusters with a different
intercept and slope. Firstly, we configure the default id, time, and
response variable, so that these do not need to be provided to the other
function calls.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/philips-software/latrend" class="external-link">latrend</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span></span>
<span>  latrend.id <span class="op">=</span> <span class="st">"Traj"</span>, </span>
<span>  latrend.time <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>  latrend.verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we generate the dataset, with 40 trajectories for cluster A and
60 trajectories for cluster B. Cluster A involves trajectories with a
downward slope, whereas cluster B has an upward slope. We define a fixed
mean of 1, such that all the cluster trajectories are shifted, placing
cluster A at intercept 2, and cluster B at intercept 1.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">casedata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateLongData.html">generateLongData</a></span><span class="op">(</span></span>
<span>  sizes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">60</span><span class="op">)</span>, </span>
<span>  data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Time <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>  fixed <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  fixedCoefs <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  cluster <span class="op">=</span> <span class="op">~</span> <span class="va">Time</span>, </span>
<span>  clusterCoefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">.1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.05</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  random <span class="op">=</span> <span class="op">~</span> <span class="va">Time</span>,</span>
<span>  randomScales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.02</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="fl">.02</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  noiseScales <span class="op">=</span> <span class="fl">.05</span></span>
<span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We plot the data to get a sense of different trajectories that have
been generated. Visually, there is little group separation.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotTrajectories.html">plotTrajectories</a></span><span class="op">(</span><span class="va">casedata</span>, response <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span></code></pre></div>
<p><img src="implement_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>Since we generated the data, we have the luxury of looking at
reference cluster trajectories, as stored in the <code>Mu.cluster</code>
column. Note that <code>Mu.fixed</code> must be added to obtain the
correct values.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plotClusterTrajectories.html">plotClusterTrajectories</a></span><span class="op">(</span><span class="va">casedata</span>, response <span class="op">=</span> <span class="st">"Y"</span>, cluster <span class="op">=</span> <span class="st">"Class"</span><span class="op">)</span></span></code></pre></div>
<p><img src="implement_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="stratification">Stratification<a class="anchor" aria-label="anchor" href="#stratification"></a>
</h2>
<p>Rather than starting with clustering, in some case studies there may
be prior knowledge on how to sensibly stratify the trajectories. Either
by an observed independent variable (e.g., age or gender), or a certain
aspect of the observed trajectory (e.g., the intercept, slope,
variability).</p>
<p>Let’s presume in this example that domain knowledge suggests that
stratifying by the intercept may provide a sensible grouping of the
trajectories. This approach is further supported by the density plot of
the trajectory intercepts, which shows a bimodal distribution.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">casedata</span><span class="op">[</span><span class="va">Time</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Mu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"gray"</span>, adjust <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span></span></code></pre></div>
<p><img src="implement_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Based on the density plot, we will assign trajectories with an
intercept above 1.6 to cluster A, and the remainder to cluster B.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcMethodStratify.html">lcMethodStratify</a></span><span class="op">(</span>response <span class="op">=</span> <span class="st">"Y"</span>, <span class="va">Y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1.6</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">method</span>, <span class="va">casedata</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/clusterProportions.html">clusterProportions</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt;   A   B </span></span>
<span><span class="co">#&gt; 0.6 0.4</span></span></code></pre></div>
<p>The approach we specified requires the first observation to be
available, and is sensitive to noise. A more robust alternative would be
to fit a linear model per trajectory, and to use the estimated intercept
to stratify the trajectories on.</p>
<p>We can specify this stratification model by defining a function which
takes the data of separate trajectories as input. This function should
return a single cluster assignment for the respective trajectory. By
returning a factor, we can pre-specify the cluster names.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stratfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Time</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">int</span> <span class="op">&gt;</span> <span class="fl">1.7</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"High"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcMethodStratify.html">lcMethodStratify</a></span><span class="op">(</span>response <span class="op">=</span> <span class="st">"Y"</span>, stratify <span class="op">=</span> <span class="va">stratfun</span>, center <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">m2</span>, <span class="va">casedata</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/clusterProportions.html">clusterProportions</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span></span>
<span><span class="co">#&gt;  Low High </span></span>
<span><span class="co">#&gt;  0.6  0.4</span></span></code></pre></div>
<p>In case the linear regression step is time-intensive, a more
efficient approach is to save the pre-computed trajectory intercepts as
a column in the original data. This column can then be referred to in
the expression of the stratification model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">casedata</span><span class="op">[</span>, <span class="va">Intercept</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Time</span>, <span class="va">.SD</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, by <span class="op">=</span> <span class="va">Traj</span><span class="op">]</span></span>
<span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcMethodStratify.html">lcMethodStratify</a></span><span class="op">(</span></span>
<span>  response <span class="op">=</span> <span class="st">"Y"</span>, </span>
<span>  stratify <span class="op">=</span> <span class="va">Intercept</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">1.7</span>, </span>
<span>  clusterNames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Low"</span>, <span class="st">"High"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">m3</span>, <span class="va">casedata</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="two-step-clustering">Two-step clustering<a class="anchor" aria-label="anchor" href="#two-step-clustering"></a>
</h2>
<p>We can take the approach involving the estimation of a linear model
per trajectory one step further. Instead of using a pre-defined
threshold on the intercept, we use a cluster algorithm on both the
intercept and slope to automatically find clusters.</p>
<p>We first define the representation step, which estimates the model
coefficients per trajectory, and outputs a <code>matrix</code> with the
coefficients per trajectory per row.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">repStep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">data</span>, <span class="va">verbose</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">coefdata</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Time</span>, <span class="va">.SD</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="va">Traj</span><span class="op">]</span></span>
<span>  <span class="va">coefmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">coefdata</span>, select <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dtwclust/man/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">coefmat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">coefdata</span><span class="op">$</span><span class="va">Traj</span></span>
<span>  <span class="va">coefmat</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The cluster step takes the coefficient matrix as input. A
cross-sectional cluster algorithm can then be applied to the matrix. In
this example, we apply <span class="math inline">\(k\)</span>-means. The
cluster step should output a <code>lcModel</code> object.</p>
<p>The <code>lcModelPartition</code> function creates a
<code>lcModel</code> object for a given vector of cluster
assignments.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clusStep</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">data</span>, <span class="va">repMat</span>, <span class="va">envir</span>, <span class="va">verbose</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">repMat</span>, centers <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/lcModelPartition.html">lcModelPartition</a></span><span class="op">(</span></span>
<span>    response <span class="op">=</span> <span class="va">method</span><span class="op">$</span><span class="va">response</span>, </span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    trajectoryAssignments <span class="op">=</span> <span class="va">km</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>    center <span class="op">=</span> <span class="va">method</span><span class="op">$</span><span class="va">center</span>,</span>
<span>    method <span class="op">=</span> <span class="va">method</span>,</span>
<span>    model <span class="op">=</span> <span class="va">km</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We are now ready to create the <code>lcMethodFeature</code>
method.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.twostep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcMethodFeature.html">lcMethodFeature</a></span><span class="op">(</span></span>
<span>  response <span class="op">=</span> <span class="st">"Y"</span>, </span>
<span>  representationStep <span class="op">=</span> <span class="va">repStep</span>, </span>
<span>  clusterStep <span class="op">=</span> <span class="va">clusStep</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.twostep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">m.twostep</span>, data <span class="op">=</span> <span class="va">casedata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model.twostep</span><span class="op">)</span></span>
<span><span class="co">#&gt; Longitudinal cluster model using part</span></span>
<span><span class="co">#&gt; lcMethodFeature specifying "two-step clustering"</span></span>
<span><span class="co">#&gt;  standardize:    `scale`</span></span>
<span><span class="co">#&gt;  center:         `meanNA`</span></span>
<span><span class="co">#&gt;  time:           "Time"</span></span>
<span><span class="co">#&gt;  id:             "Traj"</span></span>
<span><span class="co">#&gt;  response:       "Y"</span></span>
<span><span class="co">#&gt;  representationStep:`repStep`</span></span>
<span><span class="co">#&gt;  clusterStep:    `clusStep`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Cluster sizes (K=3):</span></span>
<span><span class="co">#&gt;        A        B        C </span></span>
<span><span class="co">#&gt; 35 (35%) 25 (25%) 40 (40%) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of obs: 1100, strata (Traj): 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals:</span></span>
<span><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span><span class="co">#&gt; -3.08943 -0.67260  0.03618  0.00000  0.73723  2.64516</span></span></code></pre></div>
<div class="section level3">
<h3 id="general-approach">General approach<a class="anchor" aria-label="anchor" href="#general-approach"></a>
</h3>
<p>The two-step model defined above is hard-coded for a given formula
and a fixed number of clusters. In an exploratory setting, it is
convenient to define a parameterized method. Here, we change the two
functions to take arguments through the <code>lcMethod</code> object in
the <code>method</code> variable.</p>
<p>Note that we can introduce new arguments which are not originally
part of <code>lcMethodFeature</code> (e.g., <code>nClusters</code>) to
enable the specification of the number of clusters in our method.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">repStep.gen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">data</span>, <span class="va">verbose</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">coefdata</span> <span class="op">&lt;-</span> <span class="va">dt</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">method</span><span class="op">$</span><span class="va">formula</span>, <span class="va">.SD</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">method</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="co"># exclude the id column</span></span>
<span>  <span class="va">coefmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">coefdata</span>, select <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/dtwclust/man/as.matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">coefmat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">coefdata</span><span class="op">[[</span><span class="va">method</span><span class="op">$</span><span class="va">id</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">coefmat</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">clusStep.gen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span>, <span class="va">data</span>, <span class="va">repMat</span>, <span class="va">envir</span>, <span class="va">verbose</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">repMat</span>, centers <span class="op">=</span> <span class="va">method</span><span class="op">$</span><span class="va">nClusters</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/lcModelPartition.html">lcModelPartition</a></span><span class="op">(</span></span>
<span>    response <span class="op">=</span> <span class="va">method</span><span class="op">$</span><span class="va">response</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data</span>, </span>
<span>    trajectoryAssignments <span class="op">=</span> <span class="va">km</span><span class="op">$</span><span class="va">cluster</span>,</span>
<span>    center <span class="op">=</span> <span class="va">method</span><span class="op">$</span><span class="va">center</span>,</span>
<span>    method <span class="op">=</span> <span class="va">method</span>,</span>
<span>    model <span class="op">=</span> <span class="va">km</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We create a new <code>lcMethodFeature</code> instance with the more
generic functions. Defining values for <code>formula</code> and
<code>nClusters</code> here makes these arguments values act as default
values in a call of <code>latrend</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m.twostepgen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lcMethodFeature.html">lcMethodFeature</a></span><span class="op">(</span></span>
<span>  response <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>  representationStep <span class="op">=</span> <span class="va">repStep.gen</span>, </span>
<span>  clusterStep <span class="op">=</span> <span class="va">clusStep.gen</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>However, because we omitted the specification of <code>formula</code>
and <code>nClusters</code>, these need to be provided in the
<code>latrend</code> call.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model.twostepgen</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/latrend.html">latrend</a></span><span class="op">(</span><span class="va">m.twostepgen</span>, formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">Time</span>, nClusters <span class="op">=</span> <span class="fl">2</span>, <span class="va">casedata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model.twostepgen</span><span class="op">)</span></span>
<span><span class="co">#&gt; Longitudinal cluster model using part</span></span>
<span><span class="co">#&gt; lcMethodFeature specifying "two-step clustering"</span></span>
<span><span class="co">#&gt;  nClusters:      2</span></span>
<span><span class="co">#&gt;  formula:        Y ~ Time</span></span>
<span><span class="co">#&gt;  standardize:    `scale`</span></span>
<span><span class="co">#&gt;  center:         `meanNA`</span></span>
<span><span class="co">#&gt;  time:           "Time"</span></span>
<span><span class="co">#&gt;  id:             "Traj"</span></span>
<span><span class="co">#&gt;  response:       "Y"</span></span>
<span><span class="co">#&gt;  representationStep:`repStep.gen`</span></span>
<span><span class="co">#&gt;  clusterStep:    `clusStep.gen`</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Cluster sizes (K=2):</span></span>
<span><span class="co">#&gt;        A        B </span></span>
<span><span class="co">#&gt; 40 (40%) 60 (60%) </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Number of obs: 1100, strata (Traj): 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Scaled residuals:</span></span>
<span><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span><span class="co">#&gt; -2.9747 -0.6992  0.0589  0.0000  0.6958  2.9260</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Niek Den Teuling.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
